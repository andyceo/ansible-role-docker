---

- name: Install dependencies for Ansible apt* modules
  command: apt-get -y install python3-apt aptitude
  args:
    warn: no
  register: docker_apt_dependencies_installed
  changed_when: "'is already the newest version' not in docker_apt_dependencies_installed.stdout"
  tags:
    - docker-repository-key
    - docker-repository

- name: Add docker main repository key and remove outdated repositories keys
  apt_key:
    id: "{{ item.key.id }}"
    url: "{{ item.key.url|default(none) }}"
    state: "{{ item.state }}"
  with_items: "{{ docker.repositories }}"
  tags:
    - docker-repository-key
    - docker-repository

- name: Install python3-pycurl to make apt_repository module workable
  apt: pkg=python3-pycurl
  tags:
    - docker-repository

- name: Remove outdated docker repositories and add current one
  apt_repository:
    filename: "{{ item.filename|default('docker') }}"
    repo: "{{ item.repository }}"
    state: "{{ item.state }}"
    update_cache: yes
  with_items: "{{ docker.repositories|sort(attribute='state') }}"
  tags:
    - docker-repository

- name: Pin Docker engine release
  copy:
    dest: /etc/apt/preferences.d/docker-ce
    content: |
      Package: docker-ce
      Pin: version {{ docker.config.pin_docker_engine_to_version }}
      Pin-Priority: 1002
  when: docker.config.pin_docker_engine_to_version
  tags:
    - docker-package

- name: Remove outdated docker packages if they exists (data remain) and install current docker package
  apt:
    pkg: "{{ item.package }}"
    state: "{{ item.state }}"
    update_cache: yes
    cache_valid_time: 3600
  with_items: "{{ docker.packages|sort(attribute='state') }}"
  notify: docker-start
  tags:
    - docker-package

- meta: flush_handlers

- name: Remove default Docker OS-independent json configuration file if nothing to add to it
  file:
    path=/etc/docker/daemon.json
    state=absent
  when: not docker.config.json
  tags:
    - docker-config

- name: Generate default Docker OS-independent json configuration file
  template:
    src=daemon.json.j2
    dest=/etc/docker/daemon.json
    mode=0600
    owner=root
    group=root
  when: docker.config.json
  notify: docker-restart
  tags:
    - docker-config

- name: Create Docker user-defined networks
  shell: docker network create {{ item.name }} --driver {{ item.driver|default("bridge") }} {{ "--attachable" if item.attachable|default(False) else "" }} {{ "--opt encrypted" if item.encrypted|default(False) and item.driver == 'overlay' else "" }}
  with_items: "{{ docker.networks }}"
  ignore_errors: True
  register: docker_network_create_result
  changed_when: "docker_network_create_result|succeeded and 'already exists' not in docker_network_create_result.stderr"
  tags:
    - docker-networks

- meta: flush_handlers

- name: Install pip package to operate with python modules (needed for python docker library installation that will be used for docker-compose)
  apt: name=python3-pip state=present
  tags:
    - docker-compose

- name: Install actual python pip packages to make docker-compose workable and remove outdated pip packages
  pip: name={{ item.package }} state={{ item.state }}
  with_items: "{{ docker.pips|sort(attribute='state') }}"
  tags:
    - docker-compose

- name: Get current docker-compose version
  shell: docker-compose --version | sed -n 's|.* \([0-9.a-z\-]*\), .*|\1|p'
  args:
    chdir: "{{ docker.compose.path }}"
    removes: "docker-compose"
  register: docker_compose_version
  changed_when: false
  tags:
    - docker-compose

- debug: msg="Found docker-compose version {{ docker_compose_version.stdout }}"
  tags:
    - docker-compose

- name: Install/update/actualize docker-compose utility with checksum verification
  shell: curl -L https://github.com/docker/compose/releases/download/{{ docker.compose.version }}/docker-compose-`uname -s`-`uname -m` > docker-compose && chmod +x docker-compose && sha256sum -c <(echo '{{ docker.compose.sha256 }}  docker-compose') || rm -f docker-compose
  args:
    chdir: "{{ docker.compose.path }}"
    warn: no
    executable: /bin/bash
  when: docker_compose_version.stdout is not defined or docker_compose_version.stdout is version(docker.compose.version, '!=')
  tags:
    - docker-compose

- name: Manage secrets (Docker Swarm mode)
  docker_secret:
    name: "{{ item.name }}"
    data: "{{ item.data|default('') }}"
    labels: "{{ item.labels|default({}) }}"
    state: "{{ item.state|default('present') }}"
  with_items: "{{ docker.secrets|sort(attribute='state') }}"
  tags:
    - docker-secrets

- name: Pre-create directories for data volumes
  command: mkdir -p -m 0755 {{ item.1.split(':')[0] }}
    creates={{ item.1.split(':')[0] }}
  with_subelements:
     - "{{ docker.containers | selectattr('volumes', 'defined') | list }}"
     - volumes

- name: Orchestrate containers
  docker:
    name: "{{ item.name }}"
    image: "{{ item.image }}:{{ item.tag|default('latest') }}"
    command: "{{ item.command|default('') }}"
    state: "{{ item.state }}"
    hostname: "{{ item.hostname|default('') }}"
    detach: "{{ item.detach|default(False) }}"
    restart_policy: "{{ item.restart_policy|default('no') }}"
    net: "{{ item.net|default('') }}"
    expose: "{{ item.expose|default([]) }}"
    ports: "{{ item.ports|default([]) }}"
    volumes: "{{ item.volumes|default([]) }}"
    links: "{{ item.links|default([]) }}"
    env: "{{ item.env|default({}) }}"
    memory_limit: "{{ item.memory_limit|default(0) }}"
    privileged: "{{ item.privileged|default(False) }}"
    log_driver: "{{ item.log_driver|default('json-file') }}"
  with_items: "{{ docker.containers }}"
  when: item.enabled
  tags:
    - docker-orchestrate
