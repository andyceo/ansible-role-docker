---

- name: Install dependencies for Ansible apt* modules
  command: apt-get -y install python-apt aptitude
  register: docker_apt_dependencies_installed
  changed_when: "'is already the newest version' not in docker_apt_dependencies_installed.stdout"

- name: Add docker repository key
  apt_key:
    id: "{{ docker.data.apt_key_sig }}"
    keyserver: "{{ docker.data.apt_keyserver }}"
    state: present

- name: Install python-pycurl to make apt_repository module workable
  apt: pkg=python-pycurl

- name: Add docker repository
  apt_repository:
    repo="{{ docker.data.apt_repository }}"
    state=present
    update_cache=yes

- name: Purge old lxc-docker if it exists
  apt:
    pkg=lxc-docker
    state=absent
    purge=yes

- name: Get current core version (uname -r)
  command: uname -r
  register: docker_linux_core
  changed_when: false

- name: Install linux-image-extra to use aufs storage driver
  apt: pkg="linux-image-extra-{{ docker_linux_core.stdout }}"

- name: Finally install docker and start it daemon
  apt: pkg=docker-engine
  notify: docker-start

- meta: flush_handlers

- name: Remove default Docker OS-independent json configuration file if nothing to add to it
  file:
    path=/etc/docker/daemon.json
    state=absent
  when: "not docker.config.json"

- name: Generate default Docker OS-independent json configuration file
  template:
    src=daemon.json.j2
    dest=/etc/docker/daemon.json
    mode=0600
    owner=root
    group=root
  when: "docker.config.json"
  notify: docker-restart

- name: Create Docker user-defined networks
  shell: docker network create {{ item.name }}
  with_items: "{{ docker.data.networks }}"
  ignore_errors: True
  register: docker_network_create_result
  changed_when: "docker_network_create_result|succeeded and 'already exists' not in docker_network_create_result.stderr"
  tags:
    - docker
    - docker-networks

- meta: flush_handlers

- name: Install docker-compose
  shell: curl -L https://github.com/docker/compose/releases/download/{{ docker.data.docker_compose_version }}/docker-compose-`uname -s`-`uname -m` > docker-compose && chmod +x docker-compose
  args:
    chdir: "{{ docker.data.docker_compose_path }}"
    creates: "docker-compose"

- name: Install pip package to operate with python modules
  apt: name=python-pip state=present

- name: Install docker-py to make ansible module docker workable
  pip: name=docker-py

- name: Pre-create directories for data volumes
  command: mkdir -p -m 0755 {{ item.1.split(':')[0] }}
    creates={{ item.1.split(':')[0] }}
  with_subelements:
     - "{{ docker.containers | selectattr('volumes', 'defined') | list }}"
     - volumes

- name: Orchestrate containers
  docker:
    name: "{{ item.name }}"
    image: "{{ item.image }}:{{ item.tag|default('latest') }}"
    command: "{{ item.command|default('') }}"
    state: "{{ item.state }}"
    hostname: "{{ item.hostname|default('') }}"
    detach: "{{ item.detach|default(False) }}"
    restart_policy: "{{ item.restart_policy|default('no') }}"
    net: "{{ item.net|default('') }}"
    expose: "{{ item.expose|default([]) }}"
    ports: "{{ item.ports|default([]) }}"
    volumes: "{{ item.volumes|default([]) }}"
    links: "{{ item.links|default([]) }}"
    env: "{{ item.env|default({}) }}"
    memory_limit: "{{ item.memory_limit|default(0) }}"
    privileged: "{{ item.privileged|default(False) }}"
    log_driver: "{{ item.log_driver|default('json-file') }}"
  with_items: "{{ docker.containers }}"
  when: "{{ item.enabled }}"
  tags:
    - docker
    - docker-orchestrate

# This is the example task with all params that we can use in Ansible 1.5.4 (Ubuntu 14.04)
#- name: Example task that do something with containers
#  docker:
#    image=
#    state=started
#    command=
#    detach=yes
#    domainname
#    publish_all_ports
#    expose=
#    hostname=
#    links=redis:myredis
#    name=
#    volumes=
#    volumes_from=
